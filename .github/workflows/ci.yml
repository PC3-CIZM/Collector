name: CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop, main ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================
  # 1) JOB BACKEND
  # =========================
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    permissions:
      contents: read

    defaults:
      run:
        working-directory: backend

    env:
      # Dummy env to avoid Zod env validation crashes in CI
      AUTH0_DOMAIN: "dummy.auth0.com"
      AUTH0_AUDIENCE: "dummy-audience"
      AUTH0_MGMT_CLIENT_ID: "dummy"
      AUTH0_MGMT_CLIENT_SECRET: "dummy"
      AUTH0_MGMT_AUDIENCE: "dummy"
      CONTENT_CHECK_URL: "http://localhost"
      FRONTEND_URL: "http://localhost"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies (WITH devDependencies)
        run: |
          npm ci --include=dev
          echo "==== node_modules/.bin (backend) ===="
          ls -la node_modules/.bin || true

      - name: Backend unit tests (Jest)
        run: |
          ./node_modules/.bin/jest --version
          ./node_modules/.bin/jest

      - name: Lint (si le script existe - n'empêche pas la CI)
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build (si le script existe)
        run: npm run build --if-present

  # =========================
  # 2) JOB FRONTEND
  # =========================
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    permissions:
      contents: read

    defaults:
      run:
        working-directory: frontend

    env:
      # Dummy VITE_* so import.meta.env is not undefined in tests
      VITE_API_URL: "http://localhost:4000"
      VITE_AUTH0_DOMAIN: "dummy.auth0.com"
      VITE_AUTH0_CLIENT_ID: "dummy"
      VITE_AUTH0_AUDIENCE: "dummy"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies (WITH devDependencies)
        run: |
          npm ci --include=dev
          echo "==== node_modules/.bin (frontend) ===="
          ls -la node_modules/.bin || true

      - name: Frontend unit tests (Vitest run)
        run: |
          ./node_modules/.bin/vitest --version
          ./node_modules/.bin/vitest run

      - name: Lint (si le script existe - n'empêche pas la CI)
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build (si le script existe)
        run: npm run build --if-present

  # =========================
  # 3) JOB DOCKER : build + push GHCR
  # =========================
  docker-build:
    name: Build & push Docker images (GHCR)
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    permissions:
      contents: read
      packages: write

    env:
      IMAGE_BACKEND: ghcr.io/pc3-cizm/collector-backend
      IMAGE_FRONTEND: ghcr.io/pc3-cizm/collector-frontend
      IMAGE_DB: ghcr.io/pc3-cizm/collector-db

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.IMAGE_BACKEND }}:${{ github.sha }}
            ${{ env.IMAGE_BACKEND }}:develop
          build-args: |
            AUTH0_AUDIENCE=${{ secrets.AUTH0_AUDIENCE }}
            AUTH0_DOMAIN=${{ secrets.AUTH0_DOMAIN }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_HOST=${{ vars.DB_HOST }}
            DB_PORT=${{ vars.DB_PORT }}
            KAFKA_BROKER=${{ vars.KAFKA_BROKER }}
            AUTH0_MGMT_CLIENT_ID=${{ secrets.AUTH0_MGMT_CLIENT_ID }}
            AUTH0_MGMT_CLIENT_SECRET=${{ secrets.AUTH0_MGMT_CLIENT_SECRET }}
            AUTH0_MGMT_AUDIENCE=${{ secrets.AUTH0_MGMT_AUDIENCE }}
            CONTENT_CHECK_URL=${{ vars.CONTENT_CHECK_URL }}
            FRONTEND_URL=${{ vars.FRONTEND_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push frontend (with VITE build args)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
            ${{ env.IMAGE_FRONTEND }}:develop
          build-args: |
            VITE_API_URL=${{ vars.VITE_API_URL }}
            VITE_AUTH0_DOMAIN=${{ secrets.VITE_AUTH0_DOMAIN }}
            VITE_AUTH0_CLIENT_ID=${{ secrets.VITE_AUTH0_CLIENT_ID }}
            VITE_AUTH0_AUDIENCE=${{ secrets.VITE_AUTH0_AUDIENCE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push db (postgres seeded)
        uses: docker/build-push-action@v6
        with:
          context: ./docker/postgres
          file: ./docker/postgres/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_DB }}:${{ github.sha }}
            ${{ env.IMAGE_DB }}:develop
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =========================
  # 4) JOB DB : vérification base de données
  # =========================
  db-check:
    name: Database CI
    runs-on: ubuntu-latest
    permissions:
      contents: read

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: collector_user
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: collector_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U collector_user -d collector_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for database to be ready
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          for i in {1..10}; do
            pg_isready -h localhost -p 5432 -d collector_db -U collector_user && break
            echo "Database not ready yet, waiting..."
            sleep 3
          done

      - name: Apply init.sql (if exists)
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          if [ -f docker/postgres/init.sql ]; then
            echo "Found docker/postgres/init.sql, applying it..."
            psql -h localhost -p 5432 -U collector_user -d collector_db -f docker/postgres/init.sql
          else
            echo "No docker/postgres/init.sql file, skipping schema init"
          fi

      - name: Run simple smoke query
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          psql -h localhost -p 5432 -U collector_user -d collector_db -c "SELECT 1;"
